# Simple Tomcat Session hello world

## Scale Tomcat

- Review this file
  - [setenv.sh](./tomcat/bin/setenv.sh)
  - [server.xml](./tomcat/conf/server.xml)
  - [logging.properties](./tomcat/conf/logging.properties)
  - [Dockerfile](./tomcat/Dockerfile)
  - [docker-compose.yml](./docker-compose.yml)

```shell
docker compose build
docker compose up -d

# check health
curl http://$(docker compose port tomcat 8080)/health
curl -iL http://$(docker compose port tomcat 8080)/
# review 
curl -sL --user jolokia:jolokia \
  http://$(docker compose port tomcat 8080)/jolokia | jq .
# check accesslog
docker compose exec tomcat \
  /bin/sh -c "cat /usr/local/tomcat/logs/localhost_access_log.*"
```

## Scale with Traefik

- Sticky Session

```shell
docker compose --profile traefik up -d
curl -iL -c cookies.txt -v \
  -H "Host: tomcat.local" \
  http://$(docker compose port traefik 80)

cat cookies.txt        
# Netscape HTTP Cookie File
# https://curl.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

#HttpOnly_tomcat.local  FALSE   /       FALSE   0       JSESSIONID      1589CB43424CAA85B56A2128DFA02B03.cf235399e4a5
#HttpOnly_tomcat.local  FALSE   /       FALSE   0       TSESSIONID      4c3512b4d0a6cdd1


curl -iL -b cookies.txt -v \
 -H "Host: tomcat.local" \
 http://$(docker compose port traefik 80)


docker compose exec tomcat \
  /bin/sh -c "cat /usr/local/tomcat/logs/localhost_access_log.*"
172.29.0.3 - - [04/May/2025:18:01:28 +0000] "GET / HTTP/1.1" 200 179 -  - 
172.29.0.3 - - [04/May/2025:18:01:35 +0000] "GET / HTTP/1.1" 200 179 E4484DDD3ECD01ECCF6FDF8CD96C7428.c250dc0d9ed9  4c3512b4d0a6cdd1 
172.29.0.3 - - [04/May/2025:18:01:36 +0000] "GET / HTTP/1.1" 200 179 E4484DDD3ECD01ECCF6FDF8CD96C7428.c250dc0d9ed9  4c3512b4d0a

docker compose up --scale tomcat=2 -d

# access and check

docker stop traefik-tomcat-1

# access  doesn`t update cookie.txt
Set-Cookie: TSESSIONID=537c9e237b57d6d7; Path=/; HttpOnly
Set-Cookie: JSESSIONID=44914D639A60BFCF3BA34CC3704E5D1C.7e72dacd3e10; Path=/; HttpOnly

# reuse and replace if new cookie set!
curl -iL -c cookies.txt -b cookies.txt -v \
  -H "Host: tomcat.local" \
  http://$(docker compose port traefik 80)

docker start traefik-tomcat-1
curl -s  http://$(docker compose port traefik 8080)/api/http/services | \
 jq '.[] | select(.name == "tomcat@docker") | .loadBalancer.servers'
[
  {
    "url": "http://172.29.0.4:8080"
  },
  {
    "url": "http://172.29.0.2:8080"
  }
]
```

## Apache Tomcat Container Analysis

### JMX Access via RMI and Jolokia

- Insight:
  - JMX is exposed both via classic RMI and via Jolokia (HTTP-JSON bridge).
- Value:
  -	Enables programmatic introspection and remote monitoring (via Prometheus/Jolokia exporter).
  - Supports remote configuration and metrics collection.
- Security Concern:
  - RMI JMX must be protected behind a secured network (localhost, VPN or firewall).
  - Jolokia should have access control (IP whitelisting or token-based auth).

### Access Logs Written Only to Files

- Insight:
  - HTTP access logs (e.g., via AccessLogValve) are written to file, not stdout.
- Drawback:
  - Not Docker/Kubernetes friendly (difficult to collect with centralized logging like Fluentd, Loki, or EFK).
- Improvement:
  - Configure Tomcat to write access logs to stdout using a custom AccessLogValve configuration.

### Catalina Logs Output to stdout
	
- Insight: 
  - Main Tomcat logs (via catalina.out) are redirected to stdout, following container best practices.
- Value:
  - Logs are collected by Docker and K8s logging systems.
  - Simple to monitor via kubectl, docker logs.
- Log Formatting
  - Observation: Standard log format used.
  - Opportunity:
	- Apply JSON or structured logging format for easier parsing and indexing.
	- Use logging frameworks (like Logback via JULI replacement) for enhanced formatting.

### Standard Webapps Present

- Observation: 
  - Default webapps like examples, docs, or manager are included.
- Security Risk:
  - These are common vectors for misconfiguration and exploitation.
Action:
  - Remove unused or demo webapps from the image for production builds.

### APR Initialization but NIO Connector Used

- Insight:
  - Native APR is detected, but the default connector is still NIO.
- Implication:
  - You may benefit from APR-based performance improvements if explicitly configured.
  - Or avoid native binaries for simpler container portability.

### Java >=22 with Foreign Function & Memory API (FFM) Support

- Insight:
  - Running on Java 22, enabling FFM capabilities.
- Value:
  - Prepares Tomcat for HTTP/3 support, native IO improvements.
  - Shows future-readiness for low-level performance tuning.
  - Currently if HTTP/3 needed use Tomcat behind HTTP Proxy

Apache Tomcat 11 introduces support for OpenSSL integration via Java’s Foreign Function & Memory (FFM) API, part of Project Panama, available in Java 22 and newer. This integration allows Tomcat to utilize OpenSSL for TLS without relying on the traditional tomcat-native library

- [OpenSSL and QUIC using FFM](https://eu.communityovercode.org/sessions/2024/openssl-and-quic-using-ffm/?utm_source=chatgpt.com)

However, native support for HTTP/3 in Tomcat is not currently available. While there have been exploratory discussions and sessions on implementing HTTP/3 and QUIC using the FFM API and OpenSSL 3.3+,  these features have not been integrated into Tomcat’s official releases. As such, to leverage HTTP/3 capabilities, it’s recommended to place Tomcat behind a reverse proxy that supports HTTP/3, such as Traefik, NGINX or Apache HTTP Server.  

For developers interested in experimenting with OpenSSL integration via the FFM API in Tomcat 11, the tomcat-coyote-ffm.jar module is provided. This module is specifically designed for Java 22 and facilitates the use of OpenSSL through the FFM API. 

### Suggested Improvements for the Container Image

- Minimalist Production Build:
  - Strip manager and sample webapps.
  - Use multi-stage build to isolate only needed classes and config.
- Health and Readiness Probes:
  - Add /health endpoints via custom servlet or JMX/Jolokia check for readiness/liveness.
- Security Hardening:
  - Remove unused connectors (AJP if not needed).
  - Disable directory listing and set secure headers.
- Logging to stdout only:
  - Redirect both access and application logs to stdout.
  - Optional: convert to JSON logs for structured pipelines.
- Expose Jolokia over HTTPS:
  - Use reverse proxy (e.g., sidecar Nginx/traefik) or embed with TLS and auth.
  - Separate Management Services
- Analyse Cgroup resource restrictions

## Cgroup Constraints 

### Memory

- [Java – Container-aware Java Heap Configuration](https://pauldally.medium.com/container-aware-java-heap-configuration-45a3ebdac0c)
- [How To Configure Java Heap Size Inside a Docker Container](https://www.baeldung.com/java-docker-jvm-heap-size)
  - Springboot build with Docker and JIB
  - Before JDK 8u191 exist a problem!
- [Tuning JVM containers for better CPU and memory utilisation in K8s environment](https://medium.com/@anurag2397/solving-javas-core-problems-around-memory-and-cpu-4d0c97748c43
)

Add this to file `tomcat/bin/setenv.sh`

```text
export CATALINA_OPTS="${CATALINA_OPTS} -XX:MaxRAMPercentage=70"
# or
export CATALINA_OPTS="${CATALINA_OPTS} -Xms512M -Xmx512M"
# or
export CATALINA_OPTS="-XX:MaxRAMPercentage=70 -XX:MaxMetaspaceSize=256m -XX:+UseG1GC -XX:+UseStringDeduplication"
```

check with memory

```shell
docker compose exec tomcat \
  /bin/sh -c 'java -XX:+PrintFlagsFinal -version | grep -Ei "maxheapsize|maxram"'
docker stats traefik-tomcat-1  
```

```shell
cd memory
javac ./PrintXmxXms.java
java -cp . PrintXmxXms
Mai 04, 2025 4:44:51 PM PrintXmxXms main
INFORMATION: Initial Memory (xms) : 1.024mb
Mai 04, 2025 4:44:51 PM PrintXmxXms main
INFORMATION: Max Memory (xmx) : 16.384mb
docker build -t print-memory .
docker run --rm -ti print-memory
# 4gb
docker run --rm -ti --memory=1g print-memory
# 247m

# self restriction

docker run --rm -ti -e JAVA_OPTS="-Xms50M -Xmx50M" print-memory
May 04, 2025 2:52:18 PM PrintXmxXms main
INFO: Initial Memory (xms) : 50mb
May 04, 2025 2:52:18 PM PrintXmxXms main
INFO: Max Memory (xmx) : 50mb

# reduce with percentage
docker run --rm -ti -e JAVA_OPTS="-XX:MaxRAMPercentage=70" --memory=1g print-memory
May 04, 2025 2:58:49 PM PrintXmxXms main
INFO: Initial Memory (xms) : 16mb
May 04, 2025 2:58:49 PM PrintXmxXms main
INFO: Max Memory (xmx) : 694mb
```

### Use UBI9 images (untested)

* You need a Red Hat Account! Hups...

```shell
cat >Dockerfile <<EOF
# Use UBI 9 OpenJDK 17 base image
FROM quay.io/redhat/ubi9-openjdk-17

# Set environment variables
ENV TOMCAT_VERSION=11.0.6 \
    CATALINA_HOME=/opt/tomcat

# Install dependencies & download Tomcat
RUN microdnf install curl tar unzip -y && \
    curl -fsSL https://downloads.apache.org/tomcat/tomcat-11/v${TOMCAT_VERSION}/bin/apache-tomcat-${TOMCAT_VERSION}.tar.gz | tar xz -C /opt && \
    mv /opt/apache-tomcat-${TOMCAT_VERSION} $CATALINA_HOME && \
    rm -rf $CATALINA_HOME/webapps/* && \
    microdnf clean all

# Set working directory
WORKDIR $CATALINA_HOME

# Expose default port
EXPOSE 8080

# Start Tomcat
CMD ["bin/catalina.sh", "run"]
EOF
docker build -t custom-tomcat-ubi .

docker run -d \
  --name tomcat-demo \
  --memory=512m \
  --cpus=1.5 \
  -p 8080 \
  custom-tomcat-ubi 
docker exec -it tomcat-demo bash
# Check memory limits:
cat /sys/fs/cgroup/memory/memory.limit_in_bytes
# Check CPU quota:
cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us
exit
```

### Dynamic CPU change?

- [Kubernetes container resize policies](https://kubernetes.io/docs/tasks/configure-pod-container/resize-container-resources/#container-resize-policies)
- [Resize CPU Limit To Speed Up Java Startup on Kubernetes](https://piotrminkowski.com/2023/08/22/resize-cpu-limit-to-speed-up-java-startup-on-kubernetes/)
  -  Java apps on Kubernetes to dynamically resize the CPU limit after startup.
  - Deploy a Spring Boot Application
- [Best Practices for Java Apps on Kubernetes](https://piotrminkowski.com/2023/02/13/best-practices-for-java-apps-on-kubernetes/)

Regards,
  Peter
